{% set sub_hide = [] %}

{% for slug, contenttype in app.config.get('contenttypes') %}
    {% if isallowed('contenttype:' ~ slug) %}
        {% set sub_view = {
            icon: contenttype.icon|default(contenttype.show_in_menu ? 'files-o' : 'th-list'),
            label: __('View %contenttypes%', {'%contenttypes%': contenttype.name}),
            link: path('overview', { 'contenttypeslug': slug })
        } %}
        {% set sub_new = {
            icon: 'plus',
            label: __('New %contenttype%', {'%contenttype%': contenttype.singular_name}),
            link: path('editcontent', {'contenttypeslug': slug, 'id': ''}),
            isallowed: 'contenttype:' ~ slug ~ ':create'
        } %}
        {% set sub = [sub_view, sub_new, '-'] %}

        {# Contenttypes, where show_in_menu is set true #}
        {% if contenttype.show_in_menu %}

            {% setcontent records = slug limit 4 nohydrate %}
            {% for record in records %}
                {% set rec_title = record.title|trim %}
                {% set rec_excerpt = record.excerpt(80 - record.title|length)|trim %}
                {% set sub = sub|merge([
                    {
                        icon: contenttype.icon_singular|default('file-text-o'),
                        label: (rec_title~rec_excerpt)|length > 0 ? {title: rec_title, excerpt: rec_excerpt} : '',
                        link: path('editcontent', {'contenttypeslug': slug, 'id': record.id})
                    }
                ]) %}
            {% endfor %}

            {% set active = (page_nav == 'Content/*' and context.contenttype.slug|default == slug) %}
            {{ nav.submenu(contenttype.icon|default(''), contenttype.name, sub, active, true) }}

        {# Contenttypes, where show_in_menu is set false #}
        {% else %}

            {% set sub_hide = sub_hide|merge(sub) %}

        {% endif %}
    {% endif %}
{% endfor %}

{{ nav.submenu(contenttype.icon|default('th-list'), __('Other contenttypes'), sub_hide) }}
